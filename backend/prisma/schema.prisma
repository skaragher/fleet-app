generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String              @id @default(cuid())
  name               String
  email              String              @unique
  password           String
  role               UserRole            @default(VIEWER)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  assignedStationId  String?
  assignedVehicleId  String?
  permissions        String[]
  assignedStation    Station?            @relation("StationManagers", fields: [assignedStationId], references: [id])
  assignedVehicle    Vehicle?            @relation("VehicleManagers", fields: [assignedVehicleId], references: [id])
  vehicleAssignments VehicleAssignment[]

  @@index([assignedStationId])
  @@index([assignedVehicleId])
}

model Driver {
  id             String              @id @default(cuid())
  fullName       String
  phone          String?
  licenseNo      String              @unique
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  birthDate      DateTime?
  endDateLicence DateTime?
  typeLicence    String
  fuelDispenses  FuelDispense[]
  assignments    VehicleAssignment[]
}

model Vehicle {
  id                String              @id @default(cuid())
  plate             String              @unique
  make              String?
  model             String?
  fuelType          FuelType
  odometerKm        Int                 @default(0)
  status            VehicleStatus       @default(EN_SERVICE)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  chassisNumber     String              @unique
  commissioningDate DateTime?
  fuelDispenses     FuelDispense[]
  inspections       Inspection[]
  insurances        InsurancePolicy[]
  maintenances      Maintenance[]
  managers          User[]              @relation("VehicleManagers")
  assignments       VehicleAssignment[]
}

model VehicleAssignment {
  id        String    @id @default(cuid())
  vehicleId String
  driverId  String
  startDate DateTime  @default(now())
  endDate   DateTime?
  userId    String?
  driver    Driver    @relation(fields: [driverId], references: [id])
  user      User?     @relation(fields: [userId], references: [id])
  vehicle   Vehicle   @relation(fields: [vehicleId], references: [id])

  @@index([vehicleId])
  @@index([driverId])
  @@index([userId])
}

model Station {
  id          String         @id @default(cuid())
  name        String
  location    String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  address     String?
  openingDate DateTime?
  phone       String?
  dispenses   FuelDispense[]
  supplies    FuelSupply[]
  tanks       Tank[]
  managers    User[]         @relation("StationManagers")
}

model Tank {
  id        String         @id @default(cuid())
  stationId String
  fuelType  FuelType
  capacityL Int
  currentL  Int            @default(0)
  lowAlertL Int            @default(100)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  name      String         @default("Cuve Générique")
  dispenses FuelDispense[]
  supplies  FuelSupply[]
  station   Station        @relation(fields: [stationId], references: [id])
}

model FuelSupply {
  id          String   @id @default(cuid())
  stationId   String
  tankId      String
  supplier    String?
  deliveredL  Int
  unitPrice   Float?
  deliveryRef String?
  deliveredAt DateTime @default(now())
  notes       String?
  station     Station  @relation(fields: [stationId], references: [id])
  tank        Tank     @relation(fields: [tankId], references: [id])
}

model FuelDispense {
  id          String   @id @default(cuid())
  stationId   String
  tankId      String
  vehicleId   String
  driverId    String?
  liters      Int
  unitPrice   Float?
  odometerKm  Int
  dispensedAt DateTime @default(now())
  notes       String?
  driver      Driver?  @relation(fields: [driverId], references: [id])
  station     Station  @relation(fields: [stationId], references: [id])
  tank        Tank     @relation(fields: [tankId], references: [id])
  vehicle     Vehicle  @relation(fields: [vehicleId], references: [id])
}

model Maintenance {
  id              String          @id @default(cuid())
  vehicleId       String?
  description     String?
  cost            Float?
  odometerKm      Int
  dueAt           DateTime?
  doneAt          DateTime?
  status          String
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  maintenanceType MaintenanceType
  vehicle         Vehicle?        @relation(fields: [vehicleId], references: [id])
}

model Insurer {
  id        String            @id @default(cuid())
  name      String
  location  String?
  address   String?
  phone1    String?
  phone2    String?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  policies  InsurancePolicy[]
}

model InsurancePolicy {
  id             String         @id @default(cuid())
  vehicleId      String?
  policyNo       String?
  startAt        DateTime?
  endAt          DateTime?
  premium        Float?
  notes          String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  insurancesType InsurancesType
  insurerId      String?
  durationUnit   String?
  durationValue  Int?
  insurer        Insurer?       @relation(fields: [insurerId], references: [id])
  vehicle        Vehicle?       @relation(fields: [vehicleId], references: [id])
}

model Inspection {
  id          String    @id @default(cuid())
  vehicleId   String
  type        String    @default("VISITE_TECHNIQUE")
  scheduledAt DateTime?
  doneAt      DateTime?
  result      String?
  center      String?
  cost        Float?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  nextInspect DateTime?
  vehicle     Vehicle   @relation(fields: [vehicleId], references: [id])
}

enum VehicleStatus {
  EN_SERVICE
  EN_REPARATION
  HORS_SERVICE
}

enum InsurancesType {
  TIERS
  INTERMEDIAIRE
  TOUS_RISQUES
  RC
}

enum FuelType {
  DIESEL
  SUPER
  LUBRIFIANT
  HUILE
}

enum MaintenanceType {
  REVISION
  VIDANGE
  REPARATION
  DEPANNAGE
}

enum UserRole {
  SUPER_ADMIN
  FLEET_MANAGER
  FUEL_MANAGER
  STATION_MANAGER
  VEHICLE_MANAGER
  DRIVER
  VIEWER
}
